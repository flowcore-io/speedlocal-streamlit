graph TB
    subgraph "Entry Point"
        Main[main.py]
    end

    subgraph "UI Components"
        Sidebar[sidebar.py<br/>render_sidebar]
    end

    subgraph "Core Management"
        SessionMgr[SessionManager<br/>- set/get/has<br/>- clear_all]
        DataLoader[DataLoaderManager<br/>- load_all_tables<br/>- load_description_tables]
        FilterMgr[FilterManager<br/>- render_global_filters<br/>- render_module_filters]
    end

    subgraph "Configuration"
        Registry[ModuleRegistry<br/>- register_module<br/>- get_enabled_modules]
    end

    subgraph "Modules"
        Base[BaseModule<br/>abstract class]
        KeyInsights[KeyInsightsModule]
        EnergyEmissions[EnergyEmissionsModule]
        Development[DevelopmentModule]
    end

    subgraph "Data Layer (utils/)"
        Creator[PandasDFCreator<br/>runs SQL queries]
        Connection[connect_to_db<br/>DuckDB connection]
        QueryHelper[DuckDBQueryHelper<br/>extract_desc_tables]
        Plotter[TimesReportPlotter<br/>stacked_bar, line_plot]
    end

    subgraph "Data Storage"
        DB[(DuckDB<br/>Database)]
        CSV[mapping_db_views.csv]
    end

    %% Main flow
    Main -->|1. renders| Sidebar
    Main -->|2. creates| SessionMgr
    Main -->|3. initializes| Registry
    Main -->|4. creates if needed| DataLoader
    Main -->|5. creates| FilterMgr
    Main -->|6. loops through| Registry
    
    %% Sidebar
    Sidebar -->|config| Main
    
    %% Registry
    Registry -->|contains| KeyInsights
    Registry -->|contains| EnergyEmissions
    Registry -->|contains| Development
    
    %% Module inheritance
    Base -.->|inherits| KeyInsights
    Base -.->|inherits| EnergyEmissions
    Base -.->|inherits| Development
    
    %% DataLoader dependencies
    DataLoader -->|uses| Creator
    DataLoader -->|uses| Connection
    DataLoader -->|uses| QueryHelper
    Creator -->|reads| CSV
    Connection -->|connects to| DB
    Creator -->|queries| DB
    QueryHelper -->|queries| DB
    
    %% Module rendering
    Main -->|7. calls render on| KeyInsights
    Main -->|7. calls render on| EnergyEmissions
    Main -->|7. calls render on| Development
    
    %% Modules use plotter
    EnergyEmissions -->|creates charts| Plotter
    
    %% Session state flow
    SessionMgr -.->|stores| DataLoader
    SessionMgr -.->|stores| FilterMgr
    SessionMgr -.->|stores| Registry
    
    %% Filter flow
    FilterMgr -->|filters passed to| KeyInsights
    FilterMgr -->|filters passed to| EnergyEmissions
    FilterMgr -->|filters passed to| Development
    
    style Main fill:#e1f5ff
    style Base fill:#fff3cd
    style DB fill:#d4edda
    style CSV fill:#d4edda